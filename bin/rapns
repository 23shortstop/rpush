require "optparse"
require "rapns"
require "rapns/daemon"

options = {:poll => 2, :foreground => false}
new_argv = ARGV.clone
environment = new_argv.shift
banner = "Usage: rapns <environment> [options]"
new_argv.options do |opts|
  opts.banner = banner
  opts.on("-p", "--poll=SECONDS", Integer, "Frequency in seconds to check the database for new notifications. Default: #{options[:poll]}") { |v| options[:poll] = v }
  opts.on("-f", "--foreground", "Run in the forefround.") { options[:forefround] = true }
  opts.on("-v", "--version", "Print this version of rapns.") { puts "rapns #{Rapns::VERSION}"; exit }
  opts.on("-h", "--help", "You're looking at it.") { puts opts; exit }
end

if environment.nil?
  puts banner
  exit 1
end

ENV["RAILS_ENV"] = environment
load "config/environment.rb"

Rapns::Daemon.start(environment, options)